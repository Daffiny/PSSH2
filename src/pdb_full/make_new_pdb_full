#!/bin/bash

# rewrite of renew_pdb_full
# this script works based on the pdb table in the mysql database
# (-> extracting SEQRES and redundancy reduction are delegated to the database import)
# it writes the output a3m files to the cache and also adds psipred a3m files to the chache
# then it collects the current psipred a3m files to a directory that hhblitsdb.pl can work on

if [ -z "$conf_file" ]; then
	conf_file='/etc/pssh2.conf'
fi

usage()
{
cat << EOT
NAME
  make_new_pdb_full - generate a new pdb_full database 
SYNOPSIS
  make_new_pdb_full [-R|-F n]  [-v] <-m md5List> <-d dbName> 
DESCRIPTION
  make_new_pdb_full iterates over sequences given in the md5List (coming fron the pdb table of Aquaria),
  runs build_hhblits_profile for each sequence (to get a3m files),
  runs addss.pl on each a3m file,
  links the output a3m files to the psipred a3m directory
  and finally runs hhblitsdb.pl on the psipred a3m directory
OPTIONS
  -d          output name for new pdb_full
  -m          file containing pdb Seqres md5s to run over 
  -F n        Set force remaking status for making of HMM profile (run build_hhblits_profile):
     0           do not make profile unless none exists
     1           run only if the profile is older than the last update of uniprot20 (default)
     2           always run, even if the profile exists 
  -R          Retain (DO NOT remake) the HMM profile (same as -F 0)
  -v          be verbose
  -u          /path/to/uniprot_20_files (without extensions)
  -c          number of cpus hhblits should run in parallel (default $n_cpu)
AUTHOR
  Andrea Schafferhans <andrea.schafferhans@rostlab.org>
EOT
exit 1
}

force=1
debug=0
silent=0
passOpt=" " 
while getopts :sDF:m:Rhd:u: opt
do
	case $opt in
	D) debug=1;;
	F) force=$OPTARG;;
	R) force=0;;
	m) md5List=$OPTARG;;
	d) version=$OPTARG;;
	h) usage; exit;;
	u) u20=$OPTARG;
	s) silent=1; passOpt="$passOpt -$opt";;
	:)  echo "Error: -$OPTARG requires an argument"; usage; exit 1;;
#	*) passOpt="$passOpt -$opt";;
	esac
done

# parameters (will be overwritten by anything read from conf file)
rootDir="/mnt/project/pssh/pssh2_project/" 
pdb_full_dir=$rootDir"data/pdb_full/"
source_dir=$rootDir"src/pdb_full/"
#export HHLIB=$rootDir'hhsuite-2.0.13'
pdb_entries_dir="/mnt/project/rost_db/data/pdb/entries/"
dssp_entries_dir="/mnt/project/rost_db/data/pdb/entries/"



if [ ! -s $md5List ]
then
	echo The file of md5 numbers to iterate over does not exist or is empty
	exit 1
files


